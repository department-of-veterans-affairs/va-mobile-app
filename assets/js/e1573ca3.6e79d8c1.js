"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[9879],{50116:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var i=n(58168),a=(n(96540),n(15680));n(41873);const r={},o="Apple Signing Keys",l={unversionedId:"Engineering/DevOps/Automation Code Docs/Signing Keys/Apple",id:"Engineering/DevOps/Automation Code Docs/Signing Keys/Apple",title:"Apple Signing Keys",description:"Overview",source:"@site/docs/Engineering/DevOps/Automation Code Docs/Signing Keys/Apple.md",sourceDirName:"Engineering/DevOps/Automation Code Docs/Signing Keys",slug:"/Engineering/DevOps/Automation Code Docs/Signing Keys/Apple",permalink:"/va-mobile-app/docs/Engineering/DevOps/Automation Code Docs/Signing Keys/Apple",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Signing Keys",permalink:"/va-mobile-app/docs/Engineering/DevOps/Automation Code Docs/Signing Keys/"},next:{title:"Firebase Signing Keys",permalink:"/va-mobile-app/docs/Engineering/DevOps/Automation Code Docs/Signing Keys/Firebase"}},p={},s=[{value:"Overview",id:"overview",level:2},{value:"Fastlane Match and Apple Signing",id:"fastlane-match-and-apple-signing",level:2},{value:"Renewing Certificates",id:"renewing-certificates",level:2},{value:"Revoking old certificates",id:"revoking-old-certificates",level:3},{value:"Deleting certificates",id:"deleting-certificates",level:3},{value:"Creating new certificates",id:"creating-new-certificates",level:3},{value:"Special guidance for Apple Push Service certificates",id:"special-guidance-for-apple-push-service-certificates",level:3},{value:"Location in the CI",id:"location-in-the-ci",level:2},{value:"ENV Constants for the keys",id:"env-constants-for-the-keys",level:3},{value:"More Documentation",id:"more-documentation",level:2}],c={toc:s},g="wrapper";function d(e){let{components:t,...n}=e;return(0,a.yg)(g,(0,i.A)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("h1",{id:"apple-signing-keys"},"Apple Signing Keys"),(0,a.yg)("h2",{id:"overview"},"Overview"),(0,a.yg)("p",null,"Apple Signing and Distribution keys are obtained through the Apple Developer Portal ",(0,a.yg)("a",{parentName:"p",href:"https://developer.apple.com/account/resources/certificates/list"},"Certificates, Identifiers, and Profiles")),(0,a.yg)("p",null,"Developers will each need to have a development certificate created for them, or else a team will need a shared key for each machine."),(0,a.yg)("p",null,"Apple and iOS Distribution certificates are limited in the organization. Currently, the Health and Benefits App has its own certificate for Apple Distribution. In the future, it may be that teams have a shared signing path with different provisioning profiles, but at this time it is not necessary."),(0,a.yg)("p",null,"Apple Certificates expire every year and need to be renewed. This process is linked below and requires updating both the Certificates' area in the Developer Portal, and work to update the ",(0,a.yg)("a",{parentName:"p",href:"https://docs.fastlane.tools/actions/match"},"Fastlane Match")," system used to sign apple builds."),(0,a.yg)("h2",{id:"fastlane-match-and-apple-signing"},"Fastlane Match and Apple Signing"),(0,a.yg)("p",null,"Apple Signing in our build system is managed with ",(0,a.yg)("a",{parentName:"p",href:"https://docs.fastlane.tools/actions/match/"},"Fastlane match"),". Match manages and stores the certificates so that a single Distribution certificate can be shared with the team through GitHub authorization to the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/department-of-veterans-affairs/va-mobile-app-private"},"private, encrypted repository"),"."),(0,a.yg)("p",null,"Match can be called from a local machine to download the certificates and provisioning profiles for distribution or development. It is also used to sign certificates in the CI during Fastlane scripts."),(0,a.yg)("h2",{id:"renewing-certificates"},"Renewing Certificates"),(0,a.yg)("p",null,"In order to renew certificates you will need to revoke the old certificates with Apple and delete them from the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/department-of-veterans-affairs/va-mobile-app-private"},"private key repository"),"."),(0,a.yg)("h3",{id:"revoking-old-certificates"},"Revoking old certificates"),(0,a.yg)("p",null,"In Apple Developer, revoke ",(0,a.yg)("a",{parentName:"p",href:"https://developer.apple.com/account/resources/certificates/list"},"the old certificate(s)")," and delete the ",(0,a.yg)("a",{parentName:"p",href:"https://developer.apple.com/account/resources/profiles/list"},"associated profile(s)"),". The follow are examples for renewing a distribution certificate:"),(0,a.yg)("table",null,(0,a.yg)("thead",{parentName:"table"},(0,a.yg)("tr",{parentName:"thead"},(0,a.yg)("th",{parentName:"tr",align:null},"CERT NAME"),(0,a.yg)("th",{parentName:"tr",align:null},"TYPE"),(0,a.yg)("th",{parentName:"tr",align:null},"PLATFORM"))),(0,a.yg)("tbody",{parentName:"table"},(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"US Department of Veterans Affairs (VA)"),(0,a.yg)("td",{parentName:"tr",align:null},"Distribution"),(0,a.yg)("td",{parentName:"tr",align:null},"All")))),(0,a.yg)("table",null,(0,a.yg)("thead",{parentName:"table"},(0,a.yg)("tr",{parentName:"thead"},(0,a.yg)("th",{parentName:"tr",align:null},"PROFILE NAME"),(0,a.yg)("th",{parentName:"tr",align:null},"PLATFORM"),(0,a.yg)("th",{parentName:"tr",align:null},"TYPE"))),(0,a.yg)("tbody",{parentName:"table"},(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"match AppStore gov.va.vamobileapp"),(0,a.yg)("td",{parentName:"tr",align:null},"iOS"),(0,a.yg)("td",{parentName:"tr",align:null},"App Store")))),(0,a.yg)("h3",{id:"deleting-certificates"},"Deleting certificates"),(0,a.yg)("p",null,"Delete the following from your local copy of the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/department-of-veterans-affairs/va-mobile-app-private"},"private key repository"),": "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"- `/profiles/appstore/<filename>.mobileprovision`\n- `/certs/distribution/<filename>.cer`\n- `/certs/distribution/<filename>.p12`\n\n")),(0,a.yg)("p",null,"Then push up your changes to the remote repository.This needs to be done on in the remote repository, not just locally, as Match will clone the remote repository to a temporary directory and then try (and fail) to decrypt them. You may need to delete additional certs from other paths (e.g., ",(0,a.yg)("inlineCode",{parentName:"p"},"/certs/developer/..."),") if you run into a ",(0,a.yg)("inlineCode",{parentName:"p"},"decrpyt error")," when running the ",(0,a.yg)("inlineCode",{parentName:"p"},"fastlane match")," command below."),(0,a.yg)("h3",{id:"creating-new-certificates"},"Creating new certificates"),(0,a.yg)("p",null,"Once the certificates have been deleted from both locations you can ",(0,a.yg)("a",{parentName:"p",href:"https://docs.fastlane.tools/actions/match/#run"},"run match in your terminal")," to renew the certs\nnavigate to ",(0,a.yg)("inlineCode",{parentName:"p"},"~/VAMobile/ios/fastlane")," and then run ",(0,a.yg)("inlineCode",{parentName:"p"},"fastlane match appstore"),". You should be able to follow the prompt to create a new Distribution Certificate and Provisioning Profile that will be uploaded to the private repository and can then be used for signing apps. "),(0,a.yg)("p",null,"If you run into issues, review the following:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"Try using ",(0,a.yg)("inlineCode",{parentName:"li"},"brew install fastlane")," if your build is erroring out"),(0,a.yg)("li",{parentName:"ul"},"Does the Apple ID in the ../ios/fastlane/Appfile belong to you?"),(0,a.yg)("li",{parentName:"ul"},"The Apple ID is case sensitive. If your Apple ID password is getting rejected, this might be the issue.")),(0,a.yg)("p",null,"After generating the new certs make sure the ",(0,a.yg)("inlineCode",{parentName:"p"},"MATCH_PASSWORD")," secret in the ",(0,a.yg)("inlineCode",{parentName:"p"},"va-mobile-app")," repository is updated so GH Actions can use it and test by running the iOS On Demand workflow. If the signing part doesn't fail before build everything should be good to go. You can PR any file changes that may have happened."),(0,a.yg)("admonition",{type:"info"},(0,a.yg)("p",{parentName:"admonition"},"You may need to update the configs and profiles in the VAMobile.plist with xCode if the name strings are changed. If you receive a build error about not finding a cert, double check this first")),(0,a.yg)("h3",{id:"special-guidance-for-apple-push-service-certificates"},"Special guidance for Apple Push Service certificates"),(0,a.yg)("p",null,"Apple Push Service certificates need to be refreshed yearly in August and sent to the VANotify team. Review ",(0,a.yg)("a",{parentName:"p",href:"https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_certificate-based_connection_to_apns#2947597"},"Apple Documentation on how to create a push certificate")," and ",(0,a.yg)("a",{parentName:"p",href:"https://developer.apple.com/help/account/create-certificates/create-a-certificate-signing-request"},"how to create a signing request"),". The VA Notify team needs the certificate in ",(0,a.yg)("inlineCode",{parentName:"p"},".p12")," and the private key unencrypted (",(0,a.yg)("inlineCode",{parentName:"p"},".cer")," file). Review ",(0,a.yg)("a",{parentName:"p",href:"https://stackoverflow.com/questions/39091048/how-to-convert-a-cer-to-a-p12-file"},"documentation on converting the .cer file into .p12"),". Coordination for this happens into the ",(0,a.yg)("a",{parentName:"p",href:"https://dsva.slack.com/archives/C01CSM3EZGT"},"#va-mobile-app-push-notifications Slack channel"),"."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Full testing should be completed with QA before retiring the old certificate.")),(0,a.yg)("h2",{id:"location-in-the-ci"},"Location in the CI"),(0,a.yg)("p",null,"Apple certificates are encrypted by Fastlane match into a private repository and fetched at build time."),(0,a.yg)("p",null,"On your local machine they can be found in the Keychain Access application."),(0,a.yg)("h3",{id:"env-constants-for-the-keys"},"ENV Constants for the keys"),(0,a.yg)("p",null,"All keys are stored in match"),(0,a.yg)("h2",{id:"more-documentation"},"More Documentation"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("a",{parentName:"li",href:"https://developer.apple.com/support/code-signing/"},"Apple Codesigning Documentation")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("a",{parentName:"li",href:"https://docs.fastlane.tools/codesigning/getting-started/"},"Fastlane Codesigning Documentation"))))}d.isMDXComponent=!0},15680:(e,t,n)=>{n.d(t,{xA:()=>c,yg:()=>h});var i=n(96540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},g="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),g=s(n),u=a,h=g["".concat(p,".").concat(u)]||g[u]||d[u]||r;return n?i.createElement(h,o(o({ref:t},c),{},{components:n})):i.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[g]="string"==typeof e?e:a,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},41873:(e,t,n)=>{n(96540)}}]);