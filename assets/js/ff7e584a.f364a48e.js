"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[7953],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>l});var i=t(96540);const o={},a=i.createContext(o);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:n},e.children)}},99921:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>c,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"FrontEnd/Offline Mode","title":"Offline mode","description":"What is offline mode","source":"@site/development/FrontEnd/Offline Mode.md","sourceDirName":"FrontEnd","slug":"/FrontEnd/Offline Mode","permalink":"/va-mobile-app/development/FrontEnd/Offline Mode","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Offline mode"},"sidebar":"tutorialSidebar","previous":{"title":"Maintenance windows","permalink":"/va-mobile-app/development/FrontEnd/MaintenanceWindows"},"next":{"title":"Push notifications","permalink":"/va-mobile-app/development/FrontEnd/Push Notifications"}}');var o=t(74848),a=t(28453);const s={title:"Offline mode"},l="Offline Mode",r={},d=[{value:"What is offline mode",id:"what-is-offline-mode",level:2},{value:"How does offline mode work",id:"how-does-offline-mode-work",level:2},{value:"How do I add offline mode to my feature?",id:"how-do-i-add-offline-mode-to-my-feature",level:2},{value:"Analytics",id:"analytics",level:2},{value:"Debugging",id:"debugging",level:2},{value:"To clear the offline cache",id:"to-clear-the-offline-cache",level:2},{value:"Testing",id:"testing",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"offline-mode",children:"Offline Mode"})}),"\n",(0,o.jsx)(n.h2,{id:"what-is-offline-mode",children:"What is offline mode"}),"\n",(0,o.jsx)(n.p,{children:"Offline mode is a feature which enables the user to continue using the app with as little obstruction as possible in low connectivity environments."}),"\n",(0,o.jsx)(n.p,{children:"Disconnecting from the internet while using the app:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"No longer displays error screens for network failures."}),"\n",(0,o.jsx)(n.li,{children:"Cached data will be used to display the users\u2019 information if it has already been retrieved in this session."}),"\n",(0,o.jsx)(n.li,{children:"If data is not available for a feature, an informative message will be displayed instead of an error screen."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"how-does-offline-mode-work",children:"How does offline mode work"}),"\n",(0,o.jsx)(n.p,{children:"Enabling offline mode works by utilizing two libraries:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/react-native-netinfo/react-native-netinfo",children:"NetInfo"})," - detect the network status of the device"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://tanstack.com/query/v5/docs/framework/react/overview",children:"react-query"})," -  to store and fetch the data in the local cache"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"When the device disconnects from the network:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"NetInfo will listen for that change, display an offline mode banner app wide"}),"\n",(0,o.jsx)(n.li,{children:"Set the status for react-query to handle how data should be fetched."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"When in offline mode:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"react query will not make API requests."}),"\n",(0,o.jsx)(n.li,{children:"It will check the local cache for the query and provide that to the query caller"}),"\n",(0,o.jsx)(n.li,{children:"If no data is available in the cache for a query, an empty result is returned."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["On initial load of the App component, an event listener is set up to set the connection status for react-query using NetInfo. Offline mode is currently behind a feature flag and can be toggled by ",(0,o.jsx)(n.code,{children:"offlineMode "}),"in the remote config screen of the developer settings. After offline mode has been enabled in the remote config, restarting the app is required for it to function properly."]}),"\n",(0,o.jsx)(n.h2,{id:"how-do-i-add-offline-mode-to-my-feature",children:"How do I add offline mode to my feature?"}),"\n",(0,o.jsx)(n.p,{children:"For examples of the following steps, look at the Appointments feature code where this is fully built out."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"For any query that a feature uses to fetch data, replace the use of tanstack useQuery with useQuery from the queryClient.ts file. This will enable saving of the last updated timestamp."}),"\n",(0,o.jsx)(n.li,{children:"In that useQuery add the retry option. You can use offlineRetry as basic functionality. This helps in the case that the network fails mid-request. Instead of throwing an error to be displayed, we simply retry now that we are offline, causing the query to go to the cache instead of making a second request."}),"\n",(0,o.jsx)(n.li,{children:"To add the Last Updated Timestamp to the UI, simply provide the lastUpdatedDate that is now returned from your offline enabled query and pass it to FeatureLandingAndChildTemplate as dataUpdatedAt"}),"\n",(0,o.jsx)(n.li,{children:"The Offline Banner is a global piece of UI and is already enabled everywhere."}),"\n",(0,o.jsx)(n.li,{children:"When offline and there is no data to display from the cache, use the ContentUnavailableCard where your data would be to display a message to the user that they are offline and do not have access to the feature."}),"\n",(0,o.jsx)(n.li,{children:"Track offline mode usage for your feature with analytics by using useOfflineEventQueue with the ScreenIDTypesConstants that relates to the screen your feature is on. When the app is offline, other analytic events will not be sent since we aren't queuing all the events, just the offline mode on/off."}),"\n",(0,o.jsx)(n.li,{children:"If the feature has ui that performs an action that would require a network connection, this can be handled by short-circuiting the action and calling showOfflineSnackbar instead. To check the network status when the action is called, use useAppIsOnline and check if the connectionStatus is currently disconnected before performing your action."}),"\n",(0,o.jsx)(n.li,{children:"Ensure any interactions with offline mode are behind the offlineMode feature flag"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"analytics",children:"Analytics"}),"\n",(0,o.jsx)(n.p,{children:"These events are tracked while offline, then logged when a network connection is established in the same session."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"vama_offline_access"})," - Used to log navigation in the app. Takes the current route name as ",(0,o.jsx)(n.code,{children:"screen_name"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"vama_offline_action"})," - Used to log when the user attempts to trigger an action that would require a network connection."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"vama_offline_cache"})," - Used to log when query data is accessed from the cache. Takes the query id as ",(0,o.jsx)(n.code,{children:"value"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"vama_offline_no_data"})," - Used to log when there is no cached data for a query. Takes the query id as ",(0,o.jsx)(n.code,{children:"value"})]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"debugging",children:"Debugging"}),"\n",(0,o.jsxs)(n.p,{children:["Developers can enable offline mode without disconnecting from the network by navigating to the developer screen and enabling the Offline Debug toggle. This will add a toggle to the header representing the connection status. On for online, off for offline. This is helpful for testing ui, accessibility and basic functionality, but the features should still be tested by actually disabling the connection before features are pushed.\nThis will reset all queries to empty states. When using a physical android device connected to Android Studio, the command ",(0,o.jsx)(n.code,{children:"adb shell svc wifi enable|disable"})," can be used to enable or disable Wi-Fi. This is useful for simulating a mid-request disconnect as well as testing screen reader behavior without leaving the app to disconnect."]}),"\n",(0,o.jsx)(n.h2,{id:"to-clear-the-offline-cache",children:"To clear the offline cache"}),"\n",(0,o.jsx)(n.p,{children:"To clear the offline cache, go to the developer settings screen and press 'Reset offline storage'. This will reset all queries and delete all cached data. This is helpful for testing features that use data that loads immediately on app launch that is difficult to test with no data otherwise."}),"\n",(0,o.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"To enable offline mode in tests, pass the isOnline flag to the render function from testUtils. This will set the connection status for both react query and net info while tests are running. The default value of isOnline is true"}),"\n",(0,o.jsx)(n.li,{children:"NetInfo functionality has been fully mocked in jest/netinfoMock.ts"}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}}}]);