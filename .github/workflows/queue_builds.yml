# Reusable workflow that waits for older in progress builds to finish.
name: Queue Builds

on:
  workflow_call:

env:
  # Number of minutes to wait in between rechecking in progress workflow runs
  WAIT_TIME: 1
  # Names of the workflows that should be waited on..
  WORKFLOW_NAMES: '["Daily QA Build", "Feature Build", "Go live in app stores", "CodeQL"]'

jobs:
  queue_builds:
    name: Wait for older builds to finish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up GH CLI secret
        run: echo "${{secrets.GH_ACTIONS_PAT}}" >> token.txt
      - name: Log into GH CLI
        run: gh auth login --with-token < token.txt
      - name: Wait for older in progress builds to finish
        timeout-minutes: 60
        run: |
          can_proceed=false
          while [ "$can_proceed" == false ]; do
            echo "Fetching in progress builds"
            build_count=$(gh run list \
              --json databaseId,status,workflowName \
              --jq 'map(select(.status == "in_progress" and .databaseId < ${{ github.run_id }} and (any(.workflowName == ${{ env.WORKFLOW_NAMES }}[]; .)))) | length' )
            echo "Number of in progress builds: $build_count"
            if [ "$build_count" -eq "0" ]; then
              can_proceed=true
            else
              echo "Waiting ${{ env.WAIT_TIME }} minutes before checking in progress builds again..."
              sleep ${{ env.WAIT_TIME }}m
            fi
          done
