name: '[Admin] Prune Stale Branches'

on:
  push:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (list branches without deleting)'
        required: false
        type: boolean
        default: true

jobs:
  prune-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      deleted_count: ${{ steps.set-summary.outputs.deleted_count }}
      dry_run: ${{ steps.set-summary.outputs.dry_run }}
      branch_list: ${{ steps.set-summary.outputs.branch_list }}
      total_branches: ${{ steps.set-summary.outputs.total_branches }}
      remaining_branches: ${{ steps.set-summary.outputs.remaining_branches }}
      artifact_url: ${{ steps.get-artifact-url.outputs.artifact_url }}
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Prune stale branches
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          DRY_RUN: ${{ github.event.inputs.dry_run == 'false' && 'false' || 'true' }}
        run: |
          set +e  # Don't exit on errors, handle them gracefully
          
          echo "=== Pruning Stale Branches ==="
          echo "Dry run mode: $DRY_RUN"
          echo ""
          
          # Calculate cutoff date (90 days ago)
          CUTOFF_DATE=$(date -u -d '90 days ago' +%s 2>/dev/null || date -u -v-90d +%s)
          CUTOFF_READABLE=$(date -u -d "@$CUTOFF_DATE" '+%Y-%m-%d' 2>/dev/null || date -u -r "$CUTOFF_DATE" '+%Y-%m-%d')
          
          echo "Cutoff date: $CUTOFF_READABLE (branches with no commits after this date will be deleted)"
          echo ""
          
          # Protected branch patterns (won't be deleted)
          PROTECTED_PATTERNS=(
            "develop"
            "main"
            "master"
            "release/*"
            "release-*"
            "hotfix/*"
            "staging"
            "production"
          )
          
          # Get all remote branches
          git fetch --all --prune
          
          DELETED_COUNT=0
          PROTECTED_COUNT=0
          ACTIVE_COUNT=0
          DELETED_BRANCHES=()
          
          echo "=== Analyzing branches ==="
          echo ""
          
          # Get all remote branches except HEAD
          for branch in $(git branch -r | grep -v 'HEAD' | sed 's/origin\///'); do
            # Check if branch matches any protected pattern
            PROTECTED=false
            for pattern in "${PROTECTED_PATTERNS[@]}"; do
              if [[ "$branch" == $pattern ]]; then
                PROTECTED=true
                ((PROTECTED_COUNT++))
                break
              fi
            done
            
            if [[ "$PROTECTED" == true ]]; then
              echo "‚ö†Ô∏è  PROTECTED: $branch"
              continue
            fi
            
            # Get the last commit date for this branch
            LAST_COMMIT_DATE=$(git log -1 --format=%ct origin/"$branch" 2>/dev/null)
            
            if [[ -z "$LAST_COMMIT_DATE" ]]; then
              echo "‚ö†Ô∏è  ERROR: Could not get commit date for $branch"
              continue
            fi
            
            # Get the branch creator (author of first commit on branch)
            BRANCH_CREATOR=$(git log origin/"$branch" --reverse --format=%an | head -n1 2>/dev/null)
            
            # Get the last committer
            LAST_COMMITTER=$(git log -1 --format=%an origin/"$branch" 2>/dev/null)
            
            # Check if branch is stale
            if [[ $LAST_COMMIT_DATE -lt $CUTOFF_DATE ]]; then
              LAST_COMMIT_READABLE=$(date -u -d "@$LAST_COMMIT_DATE" '+%Y-%m-%d' 2>/dev/null || date -u -r "$LAST_COMMIT_DATE" '+%Y-%m-%d')
              DAYS_OLD=$(( ($(date +%s) - LAST_COMMIT_DATE) / 86400 ))
              
              if [[ "$DRY_RUN" == "true" ]]; then
                echo "üîç WOULD DELETE: $branch (last commit: $LAST_COMMIT_READABLE, $DAYS_OLD days old, creator: $BRANCH_CREATOR, last committer: $LAST_COMMITTER)"
                DELETED_BRANCHES+=("$branch|$BRANCH_CREATOR|$LAST_COMMITTER|$LAST_COMMIT_READABLE")
                ((DELETED_COUNT++))
              else
                echo "üóëÔ∏è  DELETING: $branch (last commit: $LAST_COMMIT_READABLE, $DAYS_OLD days old, creator: $BRANCH_CREATOR, last committer: $LAST_COMMITTER)"
                # COMMENTED OUT FOR TESTING - UNCOMMENT AFTER VERIFICATION
                # if git push origin --delete "$branch" 2>&1; then
                #   DELETED_BRANCHES+=("$branch|$BRANCH_CREATOR|$LAST_COMMITTER")
                #   ((DELETED_COUNT++))
                # else
                #   echo "   ‚ùå Failed to delete $branch"
                # fi
                
                # TEMPORARY: Simulate deletion for testing
                DELETED_BRANCHES+=("$branch|$BRANCH_CREATOR|$LAST_COMMITTER|$LAST_COMMIT_READABLE")
                ((DELETED_COUNT++))
                echo "   ‚ö†Ô∏è  DELETION DISABLED FOR TESTING - branch NOT actually deleted"
              fi
            else
              ((ACTIVE_COUNT++))
            fi
          done
          
          echo ""
          TOTAL_COUNT=$(git branch -r | grep -v 'HEAD' | sed 's/origin\///' | wc -l | tr -d ' ')
          echo "Total branches: $TOTAL_COUNT"
          echo "TOTAL_BRANCHES=$TOTAL_COUNT" >> $GITHUB_ENV
          echo "=== Summary ==="
          echo "Protected branches: $PROTECTED_COUNT"
          echo "Active branches (< 90 days): $ACTIVE_COUNT"
          echo "Total branches: $TOTAL_COUNT"
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "Branches that would be deleted: $DELETED_COUNT"
          else
            echo "Branches deleted: $DELETED_COUNT"
          fi
          
          # Create a summary for GitHub Actions
          {
            echo "### Branch Pruning Summary"
            echo ""
            echo "**Cutoff Date:** $CUTOFF_READABLE"
            echo "**Mode:** $(if [[ "$DRY_RUN" == "true" ]]; then echo "Dry Run"; else echo "Live"; fi)"
            echo ""
            echo "- üõ°Ô∏è Protected branches: $PROTECTED_COUNT"
            echo "- ‚úÖ Active branches: $ACTIVE_COUNT"
            echo "- üî¢ Total branches: $TOTAL_COUNT"
            echo "- üî¢ Remaining branches: $((TOTAL_COUNT - DELETED_COUNT))"
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "- üîç Branches that would be deleted: $DELETED_COUNT"
            else
              echo "- üóëÔ∏è Branches deleted: $DELETED_COUNT"
            fi
          } >> $GITHUB_STEP_SUMMARY
          
          # Save deleted branches to file for next step (raw pipe-delimited)
          printf '%s\n' "${DELETED_BRANCHES[@]}" > /tmp/deleted_branches.txt
          # Also create a CSV artifact for easier consumption
          echo 'branch,creator,last_committer,last_commit_date' > /tmp/deleted_branches.csv
          while IFS='|' read -r branch creator last_committer last_commit_date; do
            # Escape double quotes in fields
            esc_branch=$(printf '%s' "$branch" | sed 's/"/""/g')
            esc_creator=$(printf '%s' "$creator" | sed 's/"/""/g')
            esc_last_committer=$(printf '%s' "$last_committer" | sed 's/"/""/g')
            esc_last_commit_date=$(printf '%s' "$last_commit_date" | sed 's/"/""/g')
            printf '"%s","%s","%s","%s"\n' "$esc_branch" "$esc_creator" "$esc_last_committer" "$esc_last_commit_date" >> /tmp/deleted_branches.csv
          done < /tmp/deleted_branches.txt
          echo "DELETED_COUNT=$DELETED_COUNT" >> $GITHUB_ENV
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_ENV

      - name: Set summary outputs
        id: set-summary
        env:
          DELETED_COUNT: ${{ env.DELETED_COUNT }}
          DRY_RUN: ${{ env.DRY_RUN }}
          TOTAL_BRANCHES: ${{ env.TOTAL_BRANCHES }}
        run: |
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          
          # Format deleted branches list for Slack
          if [ -f /tmp/deleted_branches.txt ]; then
            BRANCH_LIST=""
            while IFS='|' read -r branch creator last_committer last_commit_date; do
              if [[ "$creator" == "$last_committer" ]]; then
                BRANCH_LIST="${BRANCH_LIST}‚Ä¢ \`${branch}\` (by ${creator}, last commit on ${last_commit_date})"$'\n'
              else
                BRANCH_LIST="${BRANCH_LIST}‚Ä¢ \`${branch}\` (created by ${creator}, last commit by ${last_committer} on ${last_commit_date})"$'\n'
              fi
            done < /tmp/deleted_branches.txt
            
            echo "branch_list<<EOF" >> $GITHUB_OUTPUT
            echo "$BRANCH_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "branch_list=" >> $GITHUB_OUTPUT
          fi

          echo "total_branches=$TOTAL_BRANCHES" >> $GITHUB_OUTPUT

          # Compute remaining branches (total - deleted)
          REMAINING=$((TOTAL_BRANCHES - DELETED_COUNT))
          echo "remaining_branches=$REMAINING" >> $GITHUB_OUTPUT

      - name: Upload deleted branches list
        id: upload-artifact
        if: env.DELETED_COUNT != '0'
        uses: actions/upload-artifact@v4
        with:
          name: deleted-branches-${{ github.run_id }}
          path: /tmp/deleted_branches.csv
          retention-days: 90

      - name: Get artifact download URL
        id: get-artifact-url
        if: env.DELETED_COUNT != '0'
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          ARTIFACT_URL=$(python - <<'PY'
          import os,sys,time,json,urllib.request
          repo=os.environ['GITHUB_REPOSITORY']
          run_id=os.environ['GITHUB_RUN_ID']
          token=os.environ['GITHUB_TOKEN']
          url=f"https://api.github.com/repos/{repo}/actions/runs/{run_id}/artifacts"
          headers={'Authorization':f'token {token}','Accept':'application/vnd.github+json'}
          for _ in range(6):
              try:
                  req=urllib.request.Request(url,headers=headers)
                  resp=urllib.request.urlopen(req, timeout=10)
                  data=json.load(resp)
              except Exception:
                  data={}
              name=f"deleted-branches-{run_id}"
              for a in data.get('artifacts',[]):
                  if a.get('name')==name:
                      print(a.get('archive_download_url'))
                      sys.exit(0)
              time.sleep(2)
          print('')
          PY
          )
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT

      - name: Comment on issue if scheduled
        if: github.event_name == 'schedule' && github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          echo "Scheduled run completed. Check the workflow run summary for details."

  notify-slack:
    name: Notify Slack
    needs: prune-branches
    if: always() && needs.prune-branches.outputs.deleted_count != '0'
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: 'va-mobile-sandbox'
      message: |
        üåø *Branch Pruning Summary*
        :alert: Branches with no commits in the last 90 days that would have been processed. :alert:
        
        *Results:*
        ‚Ä¢ Mode: ${{ needs.prune-branches.outputs.dry_run == 'true' && 'Dry Run üîç' || 'Live Deletion üóëÔ∏è' }}
        ‚Ä¢ Branches ${{ needs.prune-branches.outputs.dry_run == 'true' && 'that would be deleted' || 'deleted' }}: ${{ needs.prune-branches.outputs.deleted_count }}
        ‚Ä¢ Total branches: ${{ needs.prune-branches.outputs.total_branches }}
        ‚Ä¢ Remaining branches: ${{ needs.prune-branches.outputs.remaining_branches }}
        
        ‚Ä¢ Download CSV artifact: ${{ needs.prune-branches.outputs.artifact_url }}
        
        View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
