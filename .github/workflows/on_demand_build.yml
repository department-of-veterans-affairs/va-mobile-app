# On demand builds that can be run via GitHub UI at
# https://github.com/department-of-veterans-affairs/va-mobile-app/actions/workflows/on_demand_build.yml

name: '[Build] On Demand Build'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
      notes:
        description: Notes
        required: true

jobs:
  queue_build:
    name: Queue Build
    uses: ./.github/workflows/queue_builds.yml
    secrets: inherit
  sanitize_inputs:
    name: Sanitize inputs
    runs-on: ubuntu-latest
    outputs:
      notes_sanitized: ${{ steps.sanitize.outputs.notes_sanitized }}
    steps:
      - id: sanitize
        # Put the raw notes into the step environment so the runner sets it safely
        env:
          NOTES: ${{ github.event.inputs.notes }}
        run: |
          set -euo pipefail
          # Read the raw notes input from the environment (safe against quotes/backticks)
          : "Using NOTES from env"
          # Replace newlines with spaces, collapse repeated whitespace, escape double quotes, and trim to 1000 chars
          # Remove potentially dangerous characters: backticks, single and double quotes, and backslashes.
          # Then collapse whitespace and truncate to 1000 chars.
          SANITIZED=$(printf '%s' "$NOTES" \
            | tr '\r\n' ' ' \
            | sed -E 's/[[:space:]]+/ /g' \
            | sed "s/[\\\`\"']//g" \
            | sed -E 's/[[:space:]]+/ /g' \
            | cut -c1-1000)
          # Ensure we don't accidentally emit an empty output variable without the proper format
          echo "notes_sanitized=$SANITIZED" >> "$GITHUB_OUTPUT"
  start_slack_thread:
    name: Start Slack thread
    needs: [queue_build, sanitize_inputs]
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: va-mobile-build-alerts
      message: "On demand build started by ${{ github.actor }}: \"${{ needs.sanitize_inputs.outputs.notes_sanitized }}\"  (:git: `${{ github.ref_name }}`). This process may take a while. See :thread: or <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow run> for results."
  ios:
    name: iOS On Demand Build
    needs: [queue_build, start_slack_thread, sanitize_inputs]
    uses: ./.github/workflows/build_ios.yml
    secrets: inherit
    with:
      lane: on_demand
      ref: ${{ github.ref_name }}
      environment: ${{ inputs.environment }}
      notes: ${{ needs.sanitize_inputs.outputs.notes_sanitized }}
      slack_thread_ts: ${{ needs.start_slack_thread.outputs.thread_ts }}
  android:
    name: Android On Demand Build
    needs: [queue_build, start_slack_thread, sanitize_inputs]
    uses: ./.github/workflows/build_android.yml
    secrets: inherit
    with:
      lane: on_demand
      ref: ${{ github.ref_name }}
      environment: ${{ inputs.environment }}
      notes: ${{ needs.sanitize_inputs.outputs.notes_sanitized }}
      slack_thread_ts: ${{ needs.start_slack_thread.outputs.thread_ts }}
