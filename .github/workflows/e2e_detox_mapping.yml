#
# Detox e2e tests in CI
#

name: "[e2e] Detox Mapping"

on:
  workflow_call:
    outputs:
      test_matrix:
        description: "The matrix output for the e2e tests"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output1 }}
      test_run:
        description: "String saying test has been run"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output2}}

defaults:
  run:
    working-directory: VAMobile

env:
  # IAM staging app client secret
  APP_CLIENT_SECRET: ${{ secrets.APP_CLIENT_SECRET }}
  # IAM production app client secret
  APP_CLIENT_SECRET_PROD: ${{ secrets.APP_CLIENT_SECRET_PROD }}
  # Android Key Store Key Alias
  ANDROID_KS_KEY_ALIAS: ${{ secrets.ANDROID_KS_KEY_ALIAS }}
  # Android Key Store Key Alias Password
  ANDROID_KS_KEY_PW: ${{ secrets.ANDROID_KS_KEY_PW }}
  # Android Key Store Key Password
  ANDROID_KS_PW: ${{ secrets.ANDROID_KS_PW }}
  # App ID for Android project in Firebase
  FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
  # Filepath for firebase distribution key. Also used by fastlane
  FIREBASE_DIST_KEY_FILEPATH: ${{ secrets.FIREBASE_DIST_KEY_FILEPATH }}
  # Slack API token
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  find_detox_tests_to_run:
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.testing_matrix.outputs.TESTING_MATRIX }}
      output2: ${{ steps.testing_matrix.outputs.TEST_RUN}}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      - name: Get SHA
        id: get-sha
        run: echo "sha=$(git rev-parse origin/develop)" >> $GITHUB_OUTPUT
      - name: Get file difference by directory
        id: changed_files_dir
        uses: tj-actions/changed-files@v41
        with:
          dir_names: true
          json: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
      - name: Get file difference by file name
        id: changed_files_file_name
        uses: tj-actions/changed-files@v41
        with:
          json: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
      - name: Get file difference by file name
        id: changed_files_file_name_not_json
        uses: tj-actions/changed-files@v41
      - name: Get testing matrix array
        id: testing_matrix
        run: |
          for file in ${{steps.changed_files_file_name_not_json.outputs.all_changed_and_modified_files}}; do
            e2eNames=$(gh api -H "Accept: application/vnd.github+json" repos/department-of-veterans-affairs/va-mobile-app/contents/${file}\?ref=spike/9918-rachael-detox-add-what-to-run-to-code | jq --compact-output '.content |  gsub("[\\n\\t]"; "") | @base64d')
            getDetoxTestsToRunLine=$(echo $e2eNames | sed -e 's/.*detoxTestsToRun\(.*\)eslint.*/\1/')
            echo "$getDetoxTestsToRunLine"
            firstInstance=true
            if [[ "$getDetoxTestsToRunLine" != "" ]]; then
                getInitialTests=$(echo $getDetoxTestsToRunLine | sed -e 's/.*= \(.*\) \/.*/\1/')
                echo "$getInitialTests"
                if [[ "$firstInstance" == "true" ]]; then
                    getTests=${getInitialTests}
                    firstInstance=false
                else
                    getTests=$(echo $getTests | jq '. += ${test}' | unique)
                fi
            fi
          done
          echo "TESTING_MATRIX=$getTests" >> $GITHUB_OUTPUT
          echo "TEST_RUN=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# e2eNames=$(gh api repos/department-of-veterans-affairs/va-mobile-app/contents/VAMobile/src | jq --compact-output '(.[] | select(.name == "$fileName"))')
# echo "$e2eNames"
