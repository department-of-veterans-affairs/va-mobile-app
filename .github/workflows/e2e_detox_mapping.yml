#
# Detox e2e tests in CI
#

name: "[e2e] Detox Mapping"

on:
  workflow_call:
    outputs:
      test_matrix:
        description: "The matrix output for the e2e tests"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output1 }}
      test_run:
        description: "String saying test has been run"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output2}}

defaults:
  run:
    working-directory: VAMobile

env:
  # IAM staging app client secret
  APP_CLIENT_SECRET: ${{ secrets.APP_CLIENT_SECRET }}
  # IAM production app client secret
  APP_CLIENT_SECRET_PROD: ${{ secrets.APP_CLIENT_SECRET_PROD }}
  # Android Key Store Key Alias
  ANDROID_KS_KEY_ALIAS: ${{ secrets.ANDROID_KS_KEY_ALIAS }}
  # Android Key Store Key Alias Password
  ANDROID_KS_KEY_PW: ${{ secrets.ANDROID_KS_KEY_PW }}
  # Android Key Store Key Password
  ANDROID_KS_PW: ${{ secrets.ANDROID_KS_PW }}
  # App ID for Android project in Firebase
  FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
  # Filepath for firebase distribution key. Also used by fastlane
  FIREBASE_DIST_KEY_FILEPATH: ${{ secrets.FIREBASE_DIST_KEY_FILEPATH }}
  # Slack API token
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  find_detox_tests_to_run:
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.testing_matrix.outputs.TESTING_MATRIX }}
      output2: ${{ steps.testing_matrix.outputs.TEST_RUN}}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: 'spike/9918-rachael-detox-add-what-to-run-to-code'
      - name: Get SHA
        id: get-sha
        run: echo "sha=$(git rev-parse origin/develop)" >> $GITHUB_OUTPUT
      - name: Get file difference by directory
        id: changed_files_dir
        uses: tj-actions/changed-files@v41
        with:
          dir_names: true
          json: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
      - name: Get file difference by file name
        id: changed_files_file_name
        uses: tj-actions/changed-files@v41
        with:
          json: true
          dir_names: true
          dir_names_include_files: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
      - name: Check if directory/file is in detox mapping
        id: detox_mapping_check
        run: |
          directoryNames='cat ./VAMobile/e2e/package.json | jq '.directory''
          changedDirectoryLength=$(echo ${{steps.changed_files_dir.outputs.all_changed_and_modified_files}} | jq 'length')
          for ((i=0; i<$changedDirectoryLength; i+=1)); do
            directory=$(echo ${{steps.changed_files_dir.outputs.all_changed_and_modified_files}} | jq --arg number $i '.[$number]')
            baseDirectory="${##*/}"
            if [[ $(echo $directoryNames | jq --arg fileName $baseDirectory '.["$fileName"]') == null ]]; then
              exit 1
            fi
          done
          fileNames='cat ./VAMobile/e2e/package.json | jq '.files''
          changedDirectoryLength=$(echo ${{steps.changed_files_file_name.outputs.all_changed_and_modified_files}} | jq 'length')
          for ((i=0; i<$changedDirectoryLength; i+=1)); do
            file=$(echo ${{steps.changed_files_file_name.outputs.all_changed_and_modified_files}} | jq --arg number $i '.[$number]')
            baseFile="${##*/}"
            if [[ $(echo $fileNames | jq --arg fileName $baseFile '.["$fileName"]') == null ]]; then
              exit 1
            fi
          done
      - name: Check if directory/file is spelled correctly
        id: detox_mapping_spell_check
        run: |
          echo "$test"
      - name: Check if e2eNames is spelled correctly
        id: detox_mapping_e2e_names_spell_check
        run: |
          echo "$testx"
      - name: Get testing matrix array
        id: testing_matrix
        run: |
          e2eTestsToRun=[]
          for e2eName in $(gh api repos/department-of-veterans-affairs/va-mobile-app/contents/VAMobile/e2e/tests | jq --compact-output 'del(.[] | select(.name == "utils.ts")) | [.[].name]'); do  
            for file in ${{steps.changed_files_file_name_not_json.outputs.all_changed_and_modified_files}}; do
              echo "$file" 
              e2ePathNames=$(gh api repos/department-of-veterans-affairs/va-mobile-app/contents/${file}\?ref=spike/9918-rachael-detox-add-what-to-run-to-code | jq '[.[] | .name')
              echo "$e2ePathNames"
              for y in e2ePathNames: do           
                if [[ $e2eName == *$y* ]]; then
                  e2eTestsToRun += [$e2eName]
                  break
                else
                  for z in $(echo $y | sed 's/[A-Z]\+/\n&/g'); do
                  if [[$z in *$e2eName* ]]; then
                    e2eTestsToRun += [$e2eName]
                    break
                  fi
                fi
              done
            done
          done
            echo "TESTING_MATRIX=$e2eTestsToRun" >> $GITHUB_OUTPUT
            echo "TEST_RUN=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
