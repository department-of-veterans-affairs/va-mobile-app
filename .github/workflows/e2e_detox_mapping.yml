#
# Detox e2e tests in CI
#

name: "[e2e] Detox Mapping"

on:
  workflow_call:
    outputs:
      test_matrix:
        description: "The matrix output for the e2e tests"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output1 }}
      test_run:
        description: "String saying test has been run"
        value: ${{ jobs.find_detox_tests_to_run.outputs.output2}}

defaults:
  run:
    working-directory: VAMobile

env:
  # IAM staging app client secret
  APP_CLIENT_SECRET: ${{ secrets.APP_CLIENT_SECRET }}
  # IAM production app client secret
  APP_CLIENT_SECRET_PROD: ${{ secrets.APP_CLIENT_SECRET_PROD }}
  # Android Key Store Key Alias
  ANDROID_KS_KEY_ALIAS: ${{ secrets.ANDROID_KS_KEY_ALIAS }}
  # Android Key Store Key Alias Password
  ANDROID_KS_KEY_PW: ${{ secrets.ANDROID_KS_KEY_PW }}
  # Android Key Store Key Password
  ANDROID_KS_PW: ${{ secrets.ANDROID_KS_PW }}
  # App ID for Android project in Firebase
  FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
  # Filepath for firebase distribution key. Also used by fastlane
  FIREBASE_DIST_KEY_FILEPATH: ${{ secrets.FIREBASE_DIST_KEY_FILEPATH }}
  # Slack API token
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  find_detox_tests_to_run:
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.testing_matrix.outputs.TESTING_MATRIX }}
      output2: ${{ steps.testing_matrix.outputs.TEST_RUN}}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: spike/9918-rachael-detox-add-what-to-run-to-code
      - name: Get SHA
        id: get-sha
        run: echo "sha=$(git rev-parse origin/develop)" >> $GITHUB_OUTPUT
      - name: Get file difference by directory
        id: changed_files_dir
        uses: tj-actions/changed-files@v41
        with:
          dir_names: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
          path: './VAMobile/src'
      - name: Get file difference by file name
        id: changed_files_file_name
        uses: tj-actions/changed-files@v41
        with:
          dir_names: true
          dir_names_include_files: true
          base_sha: "${{ steps.get-sha.outputs.sha }}"
          path: './VAMobile/src'
      - name: Check if directory/file is in detox mapping
        id: detox_mapping_check
        run: |
          directoryNames=$(jq -r '.directory' ${{ github.workspace }}/VAMobile/e2e/detoxMapping.json)
          for directory in ${{steps.changed_files_dir.outputs.all_changed_and_modified_files}}; do
            baseDirectory=$(echo $directory | sed 's#.*/##')
            baseDirectory=$(echo $baseDirectory | sed 's/ //g')
            directoryFound=$(echo $directoryNames | jq --arg fileName "$baseDirectory" '.[$fileName]')
            if [[ "$directoryFound" == "null" ]]; then
              noDirectoryFound="true"
              break
            fi
          done
          fileNames=$(jq -r '.files' ${{ github.workspace }}/VAMobile/e2e/detoxMapping.json)
          for file in ${{steps.changed_files_file_name.outputs.all_changed_and_modified_files}}; do
            baseFile=$(echo $file | sed 's#.*/##')
            baseFile=$(echo $baseFile | sed 's/ //g')
            fileFound=$(echo $directoryNames | jq --arg fileName "$baseFile" '.[$fileName]')
            if [[ "$fileFound" == "nulle" ]]; then
              noFilesFound="true"
              break
            fi
          done
          if [[ "$noDirectoryFound" == "true" || "$noFilesFound" == "true" ]]; then
            exit 1
          fi
      - name: Check if directory/file is spelled correctly
        id: detox_mapping_spell_check
        run: |
          directoryNames=$(jq -r '.directory' ${{ github.workspace }}/VAMobile/e2e/detoxMapping.json)
          for directory in $(echo $directoryNames | jq 'keys | .[]'); do
            if [[ ! $(find ${{ github.workspace }}/VAMobile/src -type d -name '$directory') ]]; then
              directoryMisspelled="true"
            fi
          done
          fileNames=$(jq -r '.files' ${{ github.workspace }}/VAMobile/e2e/detoxMapping.json)
          for file in $(echo $fileNames | jq 'keys | .[]'); do
            if [[ ! $(find ${{ github.workspace }}/VAMobile/src -type d -name '$file') ]]; then
              fileMisspelled="true"
            fi
          done
          if [[ "$directorymisspeled" == "true" || "$filesMisspelled" == "true"]; then
            exit 1
          fi
      - name: Check if e2eNames is spelled correctly
        id: detox_mapping_e2e_names_spell_check
        run: |
          echo "$testx"
      - name: Get testing matrix array
        id: testing_matrix
        run: |
            echo "test"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
