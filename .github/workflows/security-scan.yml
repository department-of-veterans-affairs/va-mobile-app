name: Shai-Hulud 2.0 Security Check

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

jobs:
  security-check:
    runs-on: ubuntu-latest
    outputs:
      affected-count: ${{ steps.security_scan.outputs.affected-count }}
      security-findings-count: ${{ steps.security_scan.outputs.security-findings-count }}
      status: ${{ steps.security_scan.outputs.status }}
      scan-time: ${{ steps.security_scan.outputs.scan-time }}
      results: ${{ steps.security_scan.outputs.results }}
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}
      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
      - name: Find and display Contents.json
        run: find . -name "Contents.json" | head -n 10 | xargs head -n 10
      - uses: gensecaihq/Shai-Hulud-2.0-Detector@v1
        id: security_scan
        with:
          fail-on-critical: true


  restrict-package-json-updates:
    name: Restrict package.json updates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: VAMobile/package.json,VAMobile/yarn.lock,VAMobile/Gemfile.lock
      - name: Fail if package.json was changed
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Error: Direct updates to package.json, yarn.lock, or Gemfile.lock are not allowed currently."
          exit 1

  start_slack_thread_failure:
    name: Start Slack thread for failure
    needs: security-check
    if: ${{ failure() }}
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: va-mobile-build-alerts
      message: |
        :alert:Shai-Hulud 2.0 Security Check failed!
        See <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow run> for full results.
        *Scan Results:*
        *Status*: ${{ needs.security-check.outputs.status }}
        *Affected Packages*: ${{ needs.security-check.outputs.affected-count }}
        *Security Findings*: ${{ needs.security-check.outputs.security-findings-count }}
        *Scan Time*: ${{ needs.security-check.outputs.scan-time }}ms
        *Results*: ```${{ needs.security-check.outputs.results }}```

  slack_notification_package_json_failure:
    name: Slack notification for package.json failure
    needs: restrict-package-json-updates
    if: ${{ failure() }}
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: va-mobile-build-alerts
      message: "Direct updates to package.json, yarn.lock, or Gemfile.lock are not allowed. \n See <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow run> for details."
