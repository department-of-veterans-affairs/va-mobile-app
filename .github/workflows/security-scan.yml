name: '[Security] Security Check'

on:
  push:
    branches:
      - develop
      - main
    paths:
      - '**/package.json'
  pull_request:
    branches:
      - develop
      - main
    paths:
      - '**/package.json'

jobs:
  check_for_locked_file_changes:
    name: Check for package-lock changes
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
      has_node: ${{ steps.detect-node.outputs.has_node }}
      alert_lines: ${{ steps.changed-files.outputs.alert_lines }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for package.json changes
        id: changed-files
        run: |
          set -euo pipefail

          # Determine base and head commits based on event type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            echo "Checking PR: comparing $BASE_SHA...$HEAD_SHA"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            echo "Checking push: comparing $BASE_SHA...$HEAD_SHA"
          fi

          # Run the Python script to detect dependency changes
          OUTPUT=$(python3 .github/scripts/detect_package_changes.py "$BASE_SHA" "$HEAD_SHA")

          # Parse the output
          ANY_CHANGED=$(echo "$OUTPUT" | grep "any_changed=" | cut -d= -f2)
          echo "any_changed=$ANY_CHANGED" >> "$GITHUB_OUTPUT"

          # Extract alert lines between markers
          ALERT_LINES=$(echo "$OUTPUT" | sed -n '/=== ALERT_LINES ===/,/=== END_ALERT_LINES ===/p' | grep -v "===" || true)

          echo "alert_lines<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ALERT_LINES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Print the status messages (they're in the output)
          echo "$OUTPUT" | grep -E "(✅|❌)"

      - name: Detect whether repository has Node packages
        id: detect-node
        run: |
          # Detect presence of package.json files tracked in the repo
          set -euo pipefail
          if git ls-files -- '**/package.json' | grep -q .; then
            echo "has_node=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_node=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug changed files output
        run: |
          echo "The value of 'any_changed' is ${{ steps.changed-files.outputs.any_changed }}"
          echo "The value of 'has_node' is ${{ steps.detect-node.outputs.has_node }}"

  check_approval_label:
    name: Check PR for existing approval label
    runs-on: ubuntu-latest
    outputs:
      has_approval_label: ${{ steps.check.outputs.has_approval_label }}
    steps:
      - name: Check for package-scan-complete label
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          # Default to false for non-PR events
          if [ "${GITHUB_EVENT_NAME}" != "pull_request" ]; then
            echo "has_approval_label=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          PR_NUMBER=${{ github.event.pull_request.number }}
          RESP=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}")
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json,sys
          resp=json.load(sys.stdin)
          labels=[l.get('name','') for l in resp.get('labels',[])]
          print('has_approval_label=true' if 'package-scan-complete' in labels else 'has_approval_label=false')
          PY

  request_bypass_approval:
    name: Request bypass approval
    runs-on: ubuntu-latest
    needs: [check_for_locked_file_changes, check_approval_label]
    # Only run approval job when package changes detected AND node present AND no existing approval label
    if: needs.check_for_locked_file_changes.outputs.any_changed == 'true' && needs.check_for_locked_file_changes.outputs.has_node == 'true' && needs.check_approval_label.outputs.has_approval_label == 'false'
    environment: bypass-package-lock
    steps:
      - run: echo "Approval required for package dependency changes. An admin from the required group must approve this step."
      - name: Add package-scan-complete label to PR so future pushes don't require repeated approval
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Adding label 'package-scan-complete' to PR #$PR_NUMBER"
          curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            -d '{"labels":["package-scan-complete"]}' || true

  notify_package_change:
    name: Notify package.json change
    needs: check_for_locked_file_changes
    if: needs.check_for_locked_file_changes.outputs.any_changed == 'true' && needs.check_for_locked_file_changes.outputs.has_node == 'true'
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: va-mobile-build-alerts
      message: |
        :information_source: package.json package-related changes detected
        *Repository*: ${{ github.repository }}
        *Ref*: ${{ github.ref }}
        *Run*: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow run>
        *Changes detected:*
        ```
        ${{ needs.check_for_locked_file_changes.outputs.alert_lines }}
        ```

  security-check:
    name: security-check
    runs-on: ubuntu-latest
    needs: [check_for_locked_file_changes, request_bypass_approval]
    if: |
      always() && (
        needs.check_for_locked_file_changes.outputs.any_changed == 'false' ||
        (needs.check_for_locked_file_changes.outputs.any_changed == 'true' && needs.request_bypass_approval.result == 'success')
      )
    outputs:
      affected-count: ${{ steps.security_scan.outputs.affected-count }}
      security-findings-count: ${{ steps.security_scan.outputs.security-findings-count }}
      status: ${{ steps.security_scan.outputs.status }}
      scan-time: ${{ steps.security_scan.outputs.scan-time }}
      results: ${{ steps.security_scan.outputs.results }}
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}
      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
      - uses: gensecaihq/Shai-Hulud-2.0-Detector@v1
        id: security_scan
        with:
          fail-on-critical: true

  start_slack_thread_failure:
    name: Start Slack thread for failure
    needs: security-check
    if: failure()
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      channel_name: va-mobile-build-alerts
      message: |
        :alert:Shai-Hulud 2.0 Security Check failed! :alert:
        See <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow run> for full results.
        *Scan Results:*
        *Status*: ${{ needs.security-check.outputs.status }}
        *Affected Packages*: ${{ needs.security-check.outputs.affected-count }}
        *Security Findings*: ${{ needs.security-check.outputs.security-findings-count }}
        *Scan Time*: ${{ needs.security-check.outputs.scan-time }}ms
        *Results*: ```${{ needs.security-check.outputs.results }}```
