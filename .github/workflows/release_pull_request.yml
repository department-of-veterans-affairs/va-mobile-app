name: "Create Release PRs"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Number (eg. v1.1.0)'
        required: true

jobs:
  create_prs:
    runs-on: ubuntu-latest
    steps:
      - name: 'Set up GH CLI secret'
        run: echo "${{ secrets.GITHUB_TOKEN }}" >> token.txt
      - name: 'Log into GH CLI'
        run: gh auth login --with-token < token.txt
      - name: 'Checkout repo'
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: 'Set dev PR branch name'
        run: echo "DEV_PR_BRANCH=$(echo "merge-release-${{github.event.inputs.version}}-to-develop")" >> $GITHUB_ENV
      - name: 'Set release PR branch name'
        run: echo "MASTER_PR_BRANCH=$(echo "merge-release-${{github.event.inputs.version}}-to-master")" >> $GITHUB_ENV
#      - name: 'Create PR to merge changes back to develop'
#        run: |
#          git checkout release/${{github.event.inputs.version}}
#          git checkout -b ${{env.DEV_PR_BRANCH}}
#          git push -u origin ${{env.DEV_PR_BRANCH}}
#          gh pr create -B develop -t "Merge ${{github.event.inputs.version}} to develop" -b "PR to merge ${{github.event.inputs.version}} changes into develop"
      - name: 'Create PR to merge changes back to develop'
        run: |
          git checkout master
          git checkout -b ${{env.MASTER_PR_BRANCH}}
          git fetch --all
          git merge -X theirs origin/release/${{github.event.inputs.version}} --squash
          git commit -m "Merge release/${{github.event.inputs.version}} into PR branch"
          git push -u origin ${{env.MASTER_PR_BRANCH}}
          gh pr create -B master -t ${{github.event.inputs.version}} -b "PR to merge ${{github.event.inputs.version}} changes into master and build for the stores" -a lexicalninja
      - name: 'TEST'
        run: echo ${{env.DEV_PR_BRANCH}}
