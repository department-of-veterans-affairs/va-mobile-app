name: '[Test] Release Workflows Testing'

# ‚ö†Ô∏è SAFETY: This workflow ONLY performs validation checks
# It does NOT trigger actual release workflows or make any changes
# It only runs on manual dispatch - will never auto-trigger

# This workflow allows manual testing of release workflows
on:
  workflow_dispatch:
    inputs:
      workflow_to_test:
        description: 'Which workflow to test?'
        required: true
        type: choice
        options:
          - release_pull_request
          - run_approval
          - all
      version:
        description: 'Test version number (e.g., v9.99.0)'
        required: true
        type: string
        default: 'v9.99.0'
      dry_run:
        description: 'Dry run (no actual changes)?'
        required: true
        type: boolean
        default: true

jobs:
  validate_inputs:
    runs-on: ubuntu-latest
    outputs:
      test_version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Validate inputs
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format v#.#.# (e.g., v9.99.0)"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Version format valid: $VERSION"

  test_release_pull_request:
    if: inputs.workflow_to_test == 'release_pull_request' || inputs.workflow_to_test == 'all'
    needs: validate_inputs
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}
      
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}
      
      - name: Set up GH CLI
        run: |
          echo "${{ steps.generate_token.outputs.token }}" >> token.txt
          gh auth login --with-token < token.txt
      
      - name: Check if release branch exists
        id: check_branch
        run: |
          VERSION="${{ needs.validate_inputs.outputs.test_version }}"
          if git ls-remote --heads origin release/$VERSION | grep -q release/$VERSION; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Release branch exists: release/$VERSION"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Release branch does NOT exist: release/$VERSION"
            echo "::warning::You need to create release/$VERSION branch first"
          fi
      
      - name: Test PR creation (dry run)
        if: inputs.dry_run && steps.check_branch.outputs.exists == 'true'
        run: |
          VERSION="${{ needs.validate_inputs.outputs.test_version }}"
          echo "üß™ DRY RUN: Would create the following:"
          echo "  - Branch: release-$VERSION-to-develop"
          echo "  - PR: Merge $VERSION to develop"
          echo "  - Merge branch: merge-$VERSION-to-main"
          echo "  - Tag: $VERSION on main"
          
          # Check if branches already exist
          if git ls-remote --heads origin release-$VERSION-to-develop | grep -q release-$VERSION-to-develop; then
            echo "‚ö†Ô∏è  WARNING: Branch release-$VERSION-to-develop already exists"
          fi
          
      - name: Execute PR creation (LIVE)
        if: ${{ !inputs.dry_run && steps.check_branch.outputs.exists == 'true' }}
        run: |
          VERSION="${{ needs.validate_inputs.outputs.test_version }}"
          echo "ÔøΩ SAFETY CHECK: This test workflow does NOT execute real workflows"
          echo "‚ùå BLOCKED: Would have called release_pull_request.yml with version=$VERSION"
          echo ""
          echo "To actually run the workflow, use:"
          echo "  gh workflow run release_pull_request.yml -f version=$VERSION"
          exit 1

  test_run_approval:
    if: inputs.workflow_to_test == 'run_approval' || inputs.workflow_to_test == 'all'
    needs: validate_inputs
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}
      
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
      
      - name: Test approval workflow structure
        run: |
          VERSION="${{ needs.validate_inputs.outputs.test_version }}"
          echo "üß™ Testing approval workflow for $VERSION"
          echo "‚úÖ Workflow structure validated"
          echo ""
          echo "üö® SAFETY: This test NEVER triggers real workflows"
          echo "üìã run_approval.yml must be triggered via /approve slash command"
          echo "   It cannot be tested directly without repository_dispatch event"

  test_release_branch_issue:
    if: inputs.workflow_to_test == 'all'
    needs: validate_inputs
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLAGSHIP_MOBILE_APP_ID }}
          private-key: ${{ secrets.FLAGSHIP_MOBILE_APP_PRIVATE_KEY }}
      
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
      
      - name: Test issue template
        run: |
          VERSION="${{ needs.validate_inputs.outputs.test_version }}"
          echo "üß™ Testing release branch issue workflow"
          
          # Check if issue template exists
          if [[ -f ".github/ISSUE_TEMPLATE/release_ticket.md" ]]; then
            echo "‚úÖ Release ticket template found"
          else
            echo "‚ùå Release ticket template NOT found"
          fi
          
          # Check for sev-1 and sev-2 issues
          echo "üìã Checking for severity issues..."
          gh issue list -l "sev-1" --json number,title --jq 'length' || echo "No sev-1 issues"
          gh issue list -l "sev-2" --json number,title --jq 'length' || echo "No sev-2 issues"
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

  summary:
    needs: [test_release_pull_request, test_run_approval, test_release_branch_issue]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Test Summary
        run: |
          echo "# Test Results Summary üß™"
          echo ""
          echo "## Configuration"
          echo "- Workflow: ${{ inputs.workflow_to_test }}"
          echo "- Version: ${{ inputs.version }}"
          echo "- Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "## Status"
          echo "- release_pull_request: ${{ needs.test_release_pull_request.result || 'skipped' }}"
          echo "- run_approval: ${{ needs.test_run_approval.result || 'skipped' }}"
          echo "- release_branch_issue: ${{ needs.test_release_branch_issue.result || 'skipped' }}"
