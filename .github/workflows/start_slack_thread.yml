# Reusable workflow for starting a Slack thread in the provided channel
name: '[Utils] Start Slack Thread'

on:
  workflow_call:
    inputs:
      channel_name:
        description: 'Name of the Slack channel where the thread should be started.'
        type: string
        default: 'va-mobile-build-alerts'
      message:
        description: 'Text to display for the message starting the thread.'
        type: string
        required: true
      topic:
        description: 'Optional topic to set on the channel.'
        type: string
        required: false
      update_topic:
        description: 'If true, update the channel topic to the value of `topic`.'
        type: boolean
        required: false
        default: false
    outputs:
      thread_ts:
        description: 'Timestamp of the Slack thread that was created.'
        value: ${{ jobs.start_thread.outputs.thread_ts }}
      channel_id:
        description: 'Channel ID in Slack where thread that was created.'
        value: ${{ jobs.get_channel_id.outputs.channel_id }}

env:
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  get_channel_id:
    name: Get channel ID
    runs-on: ubuntu-latest
    outputs:
      channel_id: ${{ steps.search_slack.outputs.SLACK_CHANNEL_ID }}
    steps:
      - name: Search Slack for channel ID
        id: search_slack
        run: |
          CHANNEL_NAME="${{ inputs.channel_name }}"
          id=""
          cursor=""
          last_response=""

          while :; do
            url="https://slack.com/api/conversations.list?limit=1000&types=public_channel,private_channel"
            if [[ -n "$cursor" ]]; then
              url="$url&cursor=$cursor"
            fi
            echo "Fetching conversations.list (cursor='$cursor')"
            last_response=$(curl -s -H "Authorization: Bearer $SLACK_API_TOKEN" \
              -H "Content-type: application/x-www-form-urlencoded" \
              "$url")

            ok=$(jq -r '.ok // "false"' <<< "$last_response")
            if [[ "$ok" != "true" ]]; then
              echo "Slack API error: $(jq -r '.error // "unknown"' <<< "$last_response")"
              exit 1
            fi

            # Debug: show some channel names from this page
            jq -r '.channels[]?.name' <<< "$last_response" | sed -n '1,200p' | awk '{print " - " $0}' || true

            id=$(jq -r --arg name "$CHANNEL_NAME" '.channels[]? | select(.name==$name) | .id' <<< "$last_response")
            if [[ -n "$id" && "$id" != "null" ]]; then
              echo "Found channel '$CHANNEL_NAME' -> $id"
              echo "SLACK_CHANNEL_ID=$id" >> $GITHUB_OUTPUT
              break
            fi

            cursor=$(jq -r '.response_metadata.next_cursor // empty' <<< "$last_response")
            if [[ -z "$cursor" ]]; then
              echo "No more pages and channel not found"
              exit 1
            fi
          done
  start_thread:
    name: Start thread
    runs-on: ubuntu-latest
    needs: get_channel_id
    outputs:
      thread_ts: ${{ steps.post_message.outputs.SLACK_THREAD_TS }}
    steps:
      - name: Post message to Slack
        id: post_message
        env:
          SLACK_MESSAGE: ${{ inputs.message }}
          CHANNEL_ID: ${{ needs.get_channel_id.outputs.channel_id }}
        run: |
          # Build JSON payload using jq to safely escape the message
          payload=$(jq -n \
            --arg channel "$CHANNEL_ID" \
            --arg text "$SLACK_MESSAGE" \
            '{channel: $channel, text: $text}')
          
          response=$(curl -X POST \
            -H "Authorization: Bearer $SLACK_API_TOKEN" \
            -H 'Content-type: application/json' \
            --data "$payload" \
            https://slack.com/api/chat.postMessage)
          
          # Check if the Slack API call was successful
          ok=$(echo "$response" | jq -r '.ok')
          if [ "$ok" != "true" ]; then
            echo "Slack API error response:"
            echo "$response"
            error=$(echo "$response" | jq -r '.error // "unknown error"')
            echo "Error: $error"
            exit 1
          fi
          
          ts=$(echo "$response" | jq -r '.ts')
          echo SLACK_THREAD_TS=${ts} >> $GITHUB_OUTPUT
