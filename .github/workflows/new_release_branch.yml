name: Create New Release Branch

on:
  workflow_dispatch:
  schedule:
    - cron: "30 6 * * 3" # 06:30 AM UTC every Wednesday

defaults:
  run:
    working-directory: VAMobile

jobs:
  cut_release_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set username and email
        run: |
          git config --global user.name 'VA Automation Bot'
          git config --global user.email 'va-mobileapp@adhocteam.us'

      - name: Cut release branch
        run: ./release_branch.sh
  start_slack_thread:
    name: Start Slack thread
    uses: ./.github/workflows/start_slack_thread.yml
    secrets: inherit
    with:
      message: 'Release Candidate build process starting. This build is a staging build for QA to validate and do regression testing on. Please see :thread: for results. This process may take a while.'
  ios:
    name: iOS RC Build
    needs:
      - cut_release_branch
      - start_slack_thread
    uses: ./.github/workflows/build_ios.yml
    secrets: inherit
    with:
      lane: rc
      ref: staging
      slack_thread_ts: ${{needs.start_slack_thread.outputs.thread_ts}}
  android:
    name: Android RC Build
    needs:
      - cut_release_branch
      - start_slack_thread
    uses: ./.github/workflows/build_android.yml
    secrets: inherit
    with:
      lane: rc
      ref: staging
      slack_thread_ts: ${{needs.start_slack_thread.outputs.thread_ts}}

