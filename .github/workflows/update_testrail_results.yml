name: '[e2e] Update TestRail Results'

on:
  workflow_call:
    secrets:
      TEST_RAIL_USER:
        description: "TestRail robot userid"
        required: true
      TEST_RAIL_KEY:
        description: "TestRail api key"
        required: true
    inputs:
      tests_to_test:
        type: string
        default: ''
  
defaults:
  run:
    working-directory: VAMobile

jobs:
  setup_testrail:
    runs-on: ubuntu-latest
    outputs:
      output1: ${{steps.run-id-selection.outputs.TEST_RUN_ID}}
      output2: ${{steps.section-id-selection.outputs.SECTION_RUN_ID}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # - name: Download junit file
      #   uses: actions/download-artifact@v3
      #   with:
      #     pattern: *-e2e-junit
      - name: 'Find run ID in testRail'
        id: run-id-selection
        run: | 
          resp=$(curl -X GET -H 'Content-Type: application/json' \
              -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
              "https://dsvavsp.testrail.io//index.php?/api/v2/get_runs/29&is_completed=0" | jq '.runs[] | select(.name =="Regression pass for release" or .name=="'"$(date +'%Y-%m-%d')"'") | .id')
          echo "$resp"
          echo "TEST_RUN_ID=$resp" >> "$GITHUB_OUTPUT"
          if [ "$resp" == '' ]; then
            resp=$(curl -X POST -H 'Content-Type: application/json' \
                  -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
                  -d '{"suite_id": 92, "include_all": false, "name": "'"$(date +'%Y-%m-%d')"'"}' \
                  "https://dsvavsp.testrail.io//index.php?/api/v2/add_run/29" )
            resp=$(curl -X GET -H 'Content-Type: application/json' \
                -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
                "https://dsvavsp.testrail.io//index.php?/api/v2/get_runs/29&is_completed=0" | jq '.runs[] | select(.name =="'"$(date +'%Y-%m-%d')"'") | .id')
            echo "$resp"
            echo "TEST_RUN_ID=$resp" >> "$GITHUB_OUTPUT"
          fi
      - name: 'Find section ID in testRail'
        id: section-id-selection
        run: | 
          resp=$(curl -X GET -H 'Content-Type: application/json' \
              -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
              "https://dsvavsp.testrail.io//index.php?/api/v2/get_sections/29" | jq '.sections[] | select(.name =="Automated") | .id')
          echo "$resp"
          echo "SECTION_RUN_ID=$resp" >> "$GITHUB_OUTPUT"
    
    send_test_results_to_testrail:
      needs: setup_testrail
      runs-on: ubuntu-latest

      strategy:
        matrix:
          testsuite: ${{ fromJSON(github.event.inputs.tests_to_test) }}

      steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: Download junit file
          uses: actions/download-artifact@v3
          with:
            pattern: *-e2e-junit
        - name: Python setup
          if: always()
          uses: actions/setup-python@v3
          with:
            python-version: '3.x'
        - name: TestRail CLI upload results
          if: always()
          run: |      
            pip install trcli
            trcli -y \
              -h https://dsvavsp.testrail.io/ \
              --project "VA Mobile App" \
              --project-id 29 \
              -u ${{secrets.TEST_RAIL_USER}} \
              -k ${{secrets.TEST_RAIL_KEY}} \
              parse_junit \
              --run-id ${{needs.setup_testrail.outputs.output1}} \
              --section-id ${{needs.setup_testrail.outputs.output2}} \
              -f "/home/runner/work/va-mobile-app/va-mobile-app/${{matrix.testsuite}}-e2e-junit.xml"
