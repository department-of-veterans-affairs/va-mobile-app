name: '[e2e] Update TestRail Results'

on:
  push:
    #branches:
    #  - 'dependabot/**'
    secrets:
      TEST_RAIL_USER:
        description: "TestRail robot userid"
        required: true
      TEST_RAIL_KEY:
        description: "TestRail api key"
        required: true
    workflow_dispatch:
  
defaults:
  run:
    working-directory: VAMobile

jobs:
  execute_automated_tests_ios:
    name: Execute automated tests
    uses: ./.github/workflows/e2e_ios.yml
    secrets: inherit

  send_test_results_to_testrail_ios:
    if: ${{ always() }}
    needs: execute_automated_tests_ios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download junit file
        uses: actions/download-artifact@v3
        with:
          name: e2e-junit
      - name: 'Find Run ID in testRail'
        id: run-id-selection
        run: |
          resp=$(curl -X GET -H 'Content-Type: application/json' \
              -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
              "https://dsvavsp.testrail.io//index.php?/api/v2/get_runs/29&offset=0&is_completed=0" | jq '.runs[0].id')
          echo "TEST_RUN_ID=$resp" >> "$GITHUB_OUTPUT"
      - name: Python setup
        if: always()
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: TestRail CLI upload results
        if: always()
        run: |
          pip install trcli
          trcli -y \
            -h https://dsvavsp.testrail.io/ \
            --project "VA Mobile App" \
            --project-id 29 \
            -u ${{secrets.TEST_RAIL_USER}} \
            -k ${{secrets.TEST_RAIL_KEY}} \
            parse_junit \
            --run-id ${{steps.run-id-selection.outputs.TEST_RUN_ID}} \
            --title "Regression pass for release" \
            -f "/home/runner/work/va-mobile-app/va-mobile-app/e2e-junit.xml"

  execute_automated_tests_android:
    if: ${{ always() }}
    needs: [execute_automated_tests_ios, send_test_results_to_testrail_ios]
    name: Execute automated tests
    uses: ./.github/workflows/e2e_android.yml
    secrets: inherit

  send_test_results_to_testrail_android:
    if: ${{ always() }}
    needs: execute_automated_tests_android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download junit file
        uses: actions/download-artifact@v3
        with:
          name: e2e-junit-android
      - name: 'Find Run ID in testRail'
        id: run-id-selection
        run: |
          resp=$(curl -X GET -H 'Content-Type: application/json' \
              -u "${{secrets.TEST_RAIL_USER}}:${{secrets.TEST_RAIL_KEY}}" \
              "https://dsvavsp.testrail.io//index.php?/api/v2/get_runs/29&offset=0&is_completed=0" | jq '.runs[0].id')
          echo "TEST_RUN_ID=$resp" >> "$GITHUB_OUTPUT"
      - name: Python setup
        if: always()
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - name: TestRail CLI upload results
        if: always()
        run: |
          pip install trcli
          trcli -y \
            -h https://dsvavsp.testrail.io/ \
            --project "VA Mobile App" \
            --project-id 29 \
            -u ${{secrets.TEST_RAIL_USER}} \
            -k ${{secrets.TEST_RAIL_KEY}} \
            parse_junit \
            --run-id ${{steps.run-id-selection.outputs.TEST_RUN_ID}} \
            --title "Regression pass for release" \
            -f "/home/runner/work/va-mobile-app/va-mobile-app/e2e-junit.xml"
