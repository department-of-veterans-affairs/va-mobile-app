name: '[Admin] Weekly Flagship Mobile PR Reviewer Assignment'

on:
  schedule:
    # Run every Monday at 8:33 AM EST (1:33 PM UTC)
    - cron: '33 13 * * 1'

env:
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Set reviewer and backup for the week
        id: select-reviewer
        run: |
          WEEK_NUM=$(date +%U)
          echo "Current week number: $WEEK_NUM"
          # Map week number to reviewer and backup (weeks 40-52)
          case $WEEK_NUM in
            02) REVIEWER="dumathane"; BACKUP="jmarchi";;
            03) REVIEWER="jmarchi"; BACKUP="narin";;
            04) REVIEWER="narin"; BACKUP="matthew-df";;
            05) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            06) REVIEWER="AdryienH";; BACKUP="dumathane";;
            07) REVIEWER="dumathane"; BACKUP="jmarchi";;
            08) REVIEWER="jmarchi"; BACKUP="narin";;
            09) REVIEWER="narin"; BACKUP="matthew-df";;
            10) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            11) REVIEWER="AdryienH";; BACKUP="dumathane";;
            12) REVIEWER="dumathane"; BACKUP="jmarchi";;
            13) REVIEWER="jmarchi"; BACKUP="narin";;
            14) REVIEWER="narin"; BACKUP="matthew-df";;
            15) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            16) REVIEWER="AdryienH";; BACKUP="dumathane";;
            17) REVIEWER="dumathane"; BACKUP="jmarchi";;
            18) REVIEWER="jmarchi"; BACKUP="narin";;
            19) REVIEWER="narin"; BACKUP="matthew-df";;
            20) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            21) REVIEWER="AdryienH";; BACKUP="dumathane";;
            22) REVIEWER="dumathane"; BACKUP="jmarchi";;
            23) REVIEWER="jmarchi"; BACKUP="narin";;
            24) REVIEWER="narin"; BACKUP="matthew-df";;
            25) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            26) REVIEWER="AdryienH";; BACKUP="dumathane";;
            27) REVIEWER="dumathane"; BACKUP="jmarchi";;
            28) REVIEWER="jmarchi"; BACKUP="narin";;
            29) REVIEWER="narin"; BACKUP="matthew-df";;
            30) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            31) REVIEWER="AdryienH";; BACKUP="dumathane";;
            32) REVIEWER="dumathane"; BACKUP="jmarchi";;
            33) REVIEWER="jmarchi"; BACKUP="narin";;
            34) REVIEWER="narin"; BACKUP="matthew-df";;
            35) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            36) REVIEWER="AdryienH";; BACKUP="dumathane";;
            37) REVIEWER="dumathane"; BACKUP="jmarchi";;
            38) REVIEWER="jmarchi"; BACKUP="narin";;
            39) REVIEWER="narin"; BACKUP="matthew-df";;
            40) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            41) REVIEWER="AdryienH";; BACKUP="dumathane";;
            42) REVIEWER="dumathane"; BACKUP="jmarchi";;
            43) REVIEWER="jmarchi"; BACKUP="narin";;
            44) REVIEWER="narin"; BACKUP="matthew-df";;
            45) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            46) REVIEWER="AdryienH";; BACKUP="dumathane";;
            47) REVIEWER="dumathane"; BACKUP="jmarchi";;
            48) REVIEWER="jmarchi"; BACKUP="narin";;
            49) REVIEWER="narin"; BACKUP="matthew-df";;
            50) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            51) REVIEWER="AdryienH";; BACKUP="dumathane";;
            52) REVIEWER="dumathane"; BACKUP="jmarchi";;
            *) REVIEWER="jmarchi"; BACKUP="narin";;
          esac
          declare -A GITHUB_TO_SLACK=(
            ["AdryienH"]="U08N85KC05Q"
            ["jmarchi"]="U01APSBG86A"
            ["dumathane"]="U08HW514Y8Y"
            ["keli13"]="U01ATFT0XBP"
            ["dftony"]="U08HW41SBUG"
            ["matthew-df"]="U08UWE4S3GW"
          )
          SLACK_MENTION="<@${GITHUB_TO_SLACK[$REVIEWER]}>"
          BACKUP_SLACK_MENTION="<@${GITHUB_TO_SLACK[$BACKUP]}>"
          echo "reviewer_person=$REVIEWER" >> $GITHUB_OUTPUT
          echo "slack_mention=$SLACK_MENTION" >> $GITHUB_OUTPUT
          echo "backup_person=$BACKUP" >> $GITHUB_OUTPUT
          echo "backup_slack_mention=$BACKUP_SLACK_MENTION" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUM" >> $GITHUB_OUTPUT
          echo "Selected reviewer: $REVIEWER and backup: $BACKUP for week $WEEK_NUM"

      - name: Get Slack channel ID
        id: get-channel
        run: |
          CHANNEL_NAME="va-mobile-app"
          fetch_page() {
            last_response=$(curl -X GET -H 'Authorization: Bearer '"$SLACK_API_TOKEN"' ' \
            -H 'Content-type: application/x-www-form-urlencoded' \
            https://slack.com/api/conversations.list\?limit=1000\&cursor=$cursor | jq .)
          }
          get_id() {
            id=$(jq '.channels[] | .name as $data | select($data == "'$CHANNEL_NAME'").id' <<< $last_response)
          }
          get_cursor() {
            cursor=$(jq '.response_metadata.next_cursor' <<< $last_response)
          }
          id=""
          cursor=""
          last_response=""
          fetch_page
          get_id
          while [[ -z "$id" ]]
          do
            get_cursor
            fetch_page
            get_id
          done
          echo "channel_id=${id}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        run: |
          SLACK_MENTION="${{ steps.select-reviewer.outputs.slack_mention }}"
          BACKUP_SLACK_MENTION="${{ steps.select-reviewer.outputs.backup_slack_mention }}"
          CHANNEL_ID="${{ steps.get-channel.outputs.channel_id }}"
          URL="https://department-of-veterans-affairs.github.io/va-mobile-app/gettingStarted/SetUp/DevelopmentSetUpProcess/#pull-request-review"
          MESSAGE=" *Primary channel for Mobile App & Platform Team and any comms related to mobile app features. All Mobile App epics are tracked on the Global Mobile GitHub project.*\nPull Request reviewer rotation this week: $SLACK_MENTION\nBackup reviewer: $BACKUP_SLACK_MENTION\nOn deck reviewer: <$URL>"
          echo "Sending Slack notification..."
          curl -X POST \
            -H "Authorization: Bearer $SLACK_API_TOKEN" \
            -H "Content-type: application/json" \
            -d "{\"channel\": \"$CHANNEL_ID\", \"text\": \"$MESSAGE\"}" \
            https://slack.com/api/chat.postMessage
