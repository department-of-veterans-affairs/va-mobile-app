name: '[Admin] Weekly Flagship Mobile PR Reviewer Assignment'

on:
  push:
  # schedule:
  # Run every Monday at 8:33 AM EST (1:33 PM UTC)
  # - cron: '33 13 * * 1' # Will run every Monday, but steps will gate off week number for biweekly scheduling, starting at week 7.

env:
  SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Set reviewer and backup for the week
        id: select-reviewer
        run: |
          WEEK_NUM=$(date +%U)
          echo "Current week number: $WEEK_NUM"
          # Removed week-based gating logic for testing so notifications always send
          # if [ "$WEEK_NUM" -lt 7 ] || [ $(( WEEK_NUM % 2 )) -ne 1 ]; then
          #   echo "Not a biweekly reviewer assignment week. Exiting..."
          #   exit 0
          # fi
          # Map week number to reviewer and backup (weeks 2-52)
          case $WEEK_NUM in
            02) REVIEWER="dumathane"; BACKUP="jmarchi";;
            03) REVIEWER="jmarchi"; BACKUP="narin";;
            04) REVIEWER="narin"; BACKUP="matthew-df";;
            05) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            06) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            07) REVIEWER="AdryienH"; BACKUP="dumathane";;
            08) REVIEWER="AdryienH"; BACKUP="dumathane";;
            09) REVIEWER="dumathane"; BACKUP="jmarchi";;
            10) REVIEWER="dumathane"; BACKUP="jmarchi";;
            11) REVIEWER="jmarchi"; BACKUP="narin";;
            12) REVIEWER="jmarchi"; BACKUP="narin";;
            13) REVIEWER="narin"; BACKUP="matthew-df";;
            14) REVIEWER="narin"; BACKUP="matthew-df";;
            15) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            16) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            17) REVIEWER="AdryienH"; BACKUP="dumathane";;
            18) REVIEWER="AdryienH"; BACKUP="dumathane";;
            19) REVIEWER="dumathane"; BACKUP="jmarchi";;
            20) REVIEWER="dumathane"; BACKUP="jmarchi";;
            21) REVIEWER="jmarchi"; BACKUP="narin";;
            22) REVIEWER="jmarchi"; BACKUP="narin";;
            23) REVIEWER="narin"; BACKUP="matthew-df";;
            24) REVIEWER="narin"; BACKUP="matthew-df";;
            25) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            26) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            27) REVIEWER="AdryienH"; BACKUP="dumathane";;
            28) REVIEWER="AdryienH"; BACKUP="dumathane";;
            29) REVIEWER="dumathane"; BACKUP="jmarchi";;
            30) REVIEWER="dumathane"; BACKUP="jmarchi";;
            31) REVIEWER="jmarchi"; BACKUP="narin";;
            32) REVIEWER="jmarchi"; BACKUP="narin";;
            33) REVIEWER="narin"; BACKUP="matthew-df";;
            34) REVIEWER="narin"; BACKUP="matthew-df";;
            35) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            36) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            37) REVIEWER="AdryienH"; BACKUP="dumathane";;
            38) REVIEWER="AdryienH"; BACKUP="dumathane";;
            39) REVIEWER="dumathane"; BACKUP="jmarchi";;
            40) REVIEWER="dumathane"; BACKUP="jmarchi";;
            41) REVIEWER="jmarchi"; BACKUP="narin";;
            42) REVIEWER="jmarchi"; BACKUP="narin";;
            43) REVIEWER="narin"; BACKUP="matthew-df";;
            44) REVIEWER="narin"; BACKUP="matthew-df";;
            45) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            46) REVIEWER="matthew-df"; BACKUP="AdryienH";;
            47) REVIEWER="AdryienH"; BACKUP="dumathane";;
            48) REVIEWER="AdryienH"; BACKUP="dumathane";;
            49) REVIEWER="dumathane"; BACKUP="jmarchi";;
            50) REVIEWER="dumathane"; BACKUP="jmarchi";;
            51) REVIEWER="jmarchi"; BACKUP="narin";;
            52) REVIEWER="jmarchi"; BACKUP="narin";;
            *) REVIEWER="jmarchi"; BACKUP="narin";;
          esac
          declare -A GITHUB_TO_SLACK=(
            ["AdryienH"]="U08N85KC05Q"
            ["jmarchi"]="U01APSBG86A"
            ["dumathane"]="U08HW514Y8Y"
            ["matthew-df"]="U08UWE4S3GW"
            ["narin"]="U0A7E2P2FC7"
          )
          SLACK_MENTION="<@${GITHUB_TO_SLACK[$REVIEWER]}>"
          BACKUP_SLACK_MENTION="<@${GITHUB_TO_SLACK[$BACKUP]}>"
          echo "reviewer_person=$REVIEWER" >> $GITHUB_OUTPUT
          echo "slack_mention=$SLACK_MENTION" >> $GITHUB_OUTPUT
          echo "backup_person=$BACKUP" >> $GITHUB_OUTPUT
          echo "backup_slack_mention=$BACKUP_SLACK_MENTION" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUM" >> $GITHUB_OUTPUT
          echo "Selected reviewer: $REVIEWER and backup: $BACKUP for week $WEEK_NUM"

      - name: Get #VA-Mobile-Sandbox channel ID (for testing)
        id: get-channel-va-mobile-sandbox
        run: |
          CHANNEL_NAME="va-mobile-sandbox"
          fetch_page() {
            last_response=$(curl -X GET -H 'Authorization: Bearer '"$SLACK_API_TOKEN"' ' \
            -H 'Content-type: application/x-www-form-urlencoded' \
            https://slack.com/api/conversations.list\?limit=1000\&cursor=$cursor | jq .)
          }
          get_id() {
            id=$(jq -r '.channels[] | select(.name == "'$CHANNEL_NAME'") | .id' <<< $last_response)
          }
          get_cursor() {
            cursor=$(jq -r '.response_metadata.next_cursor' <<< $last_response)
          }
          id=""
          cursor=""
          last_response=""
          fetch_page
          get_id
          while [[ -z "$id" && "$cursor" != "null" && "$cursor" != "" ]]
          do
            get_cursor
            if [[ "$cursor" != "null" && "$cursor" != "" ]]; then
              fetch_page
              get_id
            fi
          done
          echo "channel_id=$id" >> $GITHUB_OUTPUT

      # The following step fetches the real #va-mobile-app-engineering channel ID.
      # It's currently commented out for testing (we route everything to sandbox).
      # - name: Get #va-mobile-app-engineering channel ID
      #   id: get-channel-va-mobile-app-engineering
      #   run: |
      #     CHANNEL_NAME="va-mobile-app-engineering"
      #     fetch_page() {
      #       last_response=$(curl -X GET -H 'Authorization: Bearer '"$SLACK_API_TOKEN"' ' \
      #       -H 'Content-type: application/x-www-form-urlencoded' \
      #       https://slack.com/api/conversations.list\?limit=1000\&cursor=$cursor | jq .)
      #     }
      #     get_id() {
      #       id=$(jq -r '.channels[] | select(.name == "'$CHANNEL_NAME'") | .id' <<< $last_response)
      #     }
      #     get_cursor() {
      #       cursor=$(jq -r '.response_metadata.next_cursor' <<< $last_response)
      #     }
      #     id=""
      #     cursor=""
      #     last_response=""
      #     fetch_page
      #     get_id
      #     while [[ -z "$id" && "$cursor" != "null" && "$cursor" != "" ]]
      #     do
      #       get_cursor
      #       if [[ "$cursor" != "null" && "$cursor" != "" ]]; then
      #         fetch_page
      #         get_id
      #       fi
      #     done
      #     echo "channel_id=$id" >> $GITHUB_OUTPUT
      - name: Update topic in #va-mobile-app
        if: steps.select-reviewer.outputs.reviewer_person != ''
        run: |
          # Using the sandbox channel ID for testing; change to the real channel step if you add it
          CHANNEL_ID="${{ steps.get-channel-va-mobile-sandbox.outputs.channel_id }}"
          SLACK_MENTION="${{ steps.select-reviewer.outputs.slack_mention }}"
          TOPIC="Primary channel for Mobile App & Platform Team and any comms related to mobile app features. PR Reviewer: $SLACK_MENTION"
          echo "Updating topic for va-mobile-app ($CHANNEL_ID) to: $TOPIC"
          if [[ -z "$CHANNEL_ID" ]]; then
            echo "Skipping conversations.setTopic: CHANNEL_ID is empty"
          else
            curl -X POST \
              -H "Authorization: Bearer $SLACK_API_TOKEN" \
              -H "Content-type: application/json" \
              -d "{\"channel\": \"$CHANNEL_ID\", \"topic\": \"$TOPIC\"}" \
              https://slack.com/api/conversations.setTopic
          fi

      - name: Update topic in #va-mobile-app-engineering
        if: steps.select-reviewer.outputs.reviewer_person != ''
        run: |
          # Route engineering topic updates to the sandbox while testing
          CHANNEL_ID="${{ steps.get-channel-va-mobile-sandbox.outputs.channel_id }}"
          SLACK_MENTION="${{ steps.select-reviewer.outputs.slack_mention }}"
          TOPIC="Channel for Mobile App engineering comms and questions. PR Reviewer: $SLACK_MENTION"
          echo "Updating topic for va-mobile-app-engineering ($CHANNEL_ID) to: $TOPIC"
          if [[ -z "$CHANNEL_ID" ]]; then
            echo "Skipping conversations.setTopic: CHANNEL_ID is empty"
          else
            curl -X POST \
              -H "Authorization: Bearer $SLACK_API_TOKEN" \
              -H "Content-type: application/json" \
              -d "{\"channel\": \"$CHANNEL_ID\", \"topic\": \"$TOPIC\"}" \
              https://slack.com/api/conversations.setTopic
          fi
          # Removed stray duplicated loop that caused undefined function errors

      - name: Send Slack notification to #va-mobile-app
        if: steps.select-reviewer.outputs.reviewer_person != ''
        run: |
          SLACK_MENTION="${{ steps.select-reviewer.outputs.slack_mention }}"
          BACKUP_SLACK_MENTION="${{ steps.select-reviewer.outputs.backup_slack_mention }}"
          # TESTING: Routing all notifications to VA-Mobile-Sandbox
          CHANNEL_ID="${{ steps.get-channel-va-mobile-sandbox.outputs.channel_id }}"
          URL="https://department-of-veterans-affairs.github.io/va-mobile-app/gettingStarted/SetUp/DevelopmentSetUpProcess/#pull-request-review"
          MESSAGE=" *Primary channel for Mobile App & Platform Team and any comms related to mobile app features. All Mobile App epics are tracked on the Global Mobile GitHub project.*\nPull Request reviewer rotation this week: $SLACK_MENTION\nBackup reviewer: $BACKUP_SLACK_MENTION\n<$URL>"
          echo "Sending Slack notification to #va-mobile-app..."
          if [[ -z "$CHANNEL_ID" ]]; then
            echo "Skipping chat.postMessage to #va-mobile-app: CHANNEL_ID is empty"
          else
            curl -X POST \
              -H "Authorization: Bearer $SLACK_API_TOKEN" \
              -H "Content-type: application/json" \
              -d "{\"channel\": \"$CHANNEL_ID\", \"text\": \"$MESSAGE\"}" \
              https://slack.com/api/chat.postMessage
          fi

      - name: Send Slack notification to #va-mobile-app-engineering
        if: steps.select-reviewer.outputs.reviewer_person != ''
        run: |
          SLACK_MENTION="${{ steps.select-reviewer.outputs.slack_mention }}"
          BACKUP_SLACK_MENTION="${{ steps.select-reviewer.outputs.backup_slack_mention }}"
          # TESTING: Routing all notifications to VA-Mobile-Sandbox
          CHANNEL_ID="${{ steps.get-channel-va-mobile-sandbox.outputs.channel_id }}"
          # CHANNEL_ID="${{ steps.get-channel-va-mobile-app-engineering.outputs.channel_id }}"
          URL="https://department-of-veterans-affairs.github.io/va-mobile-app/gettingStarted/SetUp/DevelopmentSetUpProcess/#pull-request-review"
          MESSAGE=" *Channel for Mobile App engineering comms and questions. PR Reviewer: $SLACK_MENTION\nBackup reviewer: $BACKUP_SLACK_MENTION\n<$URL>"
          echo "Sending Slack notification to #va-mobile-app-engineering..."
          if [[ -z "$CHANNEL_ID" ]]; then
            echo "Skipping chat.postMessage to #va-mobile-app-engineering: CHANNEL_ID is empty"
          else
            curl -X POST \
              -H "Authorization: Bearer $SLACK_API_TOKEN" \
              -H "Content-type: application/json" \
              -d "{\"channel\": \"$CHANNEL_ID\", \"text\": \"$MESSAGE\"}" \
              https://slack.com/api/chat.postMessage
          fi
