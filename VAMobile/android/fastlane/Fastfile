# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do

  before_all do |lane, options|
    import('../../fastfiles/slack_commands/fastfile')
    version = options[:version]
    puts('deploying to ' + lane.to_s + ' with version: ' + version.to_s)
    latestBuild = get_latest_build_num
    if version=='qa'
      latestVersion = get_latest_version_name
      puts('latest build is ' + latestBuild.to_s)
      puts('latest version is ' + latestVersion.to_s)
      props = { latestBuild: latestBuild, latestVersion: latestVersion }
      gradle(task: 'doNewQaVersion', properties: props)
    else
      versionNumber = /\d+\.\d+\.\d+/.match(version)
      puts('latest build is ' + latestBuild.to_s)
      puts('release version is ' + versionNumber.to_s)
      props = { latestBuild: latestBuild, version: versionNumber }
      gradle(task: 'updateVersionNumber', properties: props)
    end
  end

  desc "Deploy a QA new version to the Google Play"
  lane :qa do |options|
    ENV['VERSION_NAME'] = gradle(task: '-q getVersionName').split('^^')[1]
    ENV['BUILD_NUM'] = gradle(task: '-q getBuildNum').split('^^')[1]
    gradle(task: "clean")
    gradle(task: "bundle", build_type: "Release")
    supply(track: "Development Team")
    message = "New QA build successfully uploaded to Google Play"
    slack_build_success(ENV['BUILD_NUM'], ENV['VERSION_NAME'], "QA", message, "Android")
  end

  # release lane uploads to beta track for promotion to the store on release date 
  lane :release do |options|
    puts 'Run the release lane'
    ENV['VERSION_NAME'] = gradle(task: '-q getVersionName').split('^^')[1]
        ENV['BUILD_NUM'] = gradle(task: '-q getBuildNum').split('^^')[1]
        gradle(task: "clean")
        gradle(task: "bundle", build_type: "Release")
        supply(track: "Beta")
        message = "New Production build successfully uploaded to Beta Track on Google Play"
        slack_build_success(ENV['BUILD_NUM'], ENV['VERSION_NAME'], "Beta", message, "Android")
  end

  after_all do |lane, options|
    # This block is called, only if the executed lane was successful
    name = ENV['VERSION_NAME']
    build = ENV['BUILD_NUM']
    message = 'Android version bump to ' + name + ' (' + build + ')'
    puts message
    desc "Committing Android version changes to git"
     # always reset the name to VA
    sh("git checkout ../appName.properties")
    begin
      if options[:version] == 'qa'
        sh("git stash save CI-BUILD")
        sh("git checkout develop")
        git_pull
        sh("git stash pop")
        sh("git add -A")
        sh("git commit -m '" + message + "'")
        push_to_git_remote
      end
    rescue => e
      slack_github_error(e, action)
    end
  end

  error do |lane, exception, options|
      puts("ERROR REPORT")
#       slack_build_error(exception, options[:version], "Android Build Failed", "Android")
  end

# method to get the highest build number from all tracks in the Play Store
  def get_latest_build_num
    allLanes = ["production", "beta", "Ad Hoc Production Testers","Development Team","UAT Group","VA Production Testers","VA Production Testers", "Temp - Push"]
    highest = 0
    allLanes.each do |track|
      builds = google_play_track_version_codes(track:track.to_s)
      if builds.max > highest
        highest = builds.max
      end
    end
    highest
  end

# method to get the highest version number from all tracks in the Play Store
  def get_latest_version_name
  allLanes = ["production", "beta",  "Ad Hoc Production Testers","Development Team","UAT Group","VA Production Testers","VA Production Testers", "Temp - Push"]
      highest = "0.0.0"
      allLanes.each do |track|
        versions = google_play_track_release_names(track:track.to_s)
        max = versions.max_by{ |s| Gem::Version.new(s) }
        if  max > highest
          highest = max
        end
      end
      highest
  end
end
